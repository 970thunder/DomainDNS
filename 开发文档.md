# 二级域名分发系统 — 设计与开发文档（完整整合版）

> 本文档整合了系统总体设计、数据模型、后端/前端与 Cloudflare 集成、积分机制、事务与并发、定时同步、支付、测试、部署、以及你特别提醒的**系统仪表板统计信息**（Dashboard）详尽说明和实现建议。可直接作为开发与交付的参考文档。

------

## 目录

1. 项目概述与目标
2. 核心功能与业务流程
3. 数据库设计（MySQL）— 表结构与 DDL 示例
4. 系统设置（可配置项）
5. 后端架构与主要 API（REST）
6. Cloudflare 集成实现要点
7. 申请子域：事务与并发策略（同步/异步两种）
8. 定时/手动同步策略与实现建议
9. 积分机制（完整规则与反滥用策略）
10. 用户与管理员前端界面（页面/组件建议）
11. 系统仪表板（Dashboard）设计与统计实现 
12. 安全、审计、与合规要点
13. 测试计划
14. 部署/运维建议
15. 扩展功能与交付物清单
16. 开发优先级与下一步建议

------

# 1. 项目概述与目标

构建一个面向管理员与普通用户的**二级域名分发平台**。管理员管理 Cloudflare 账号与域名，设定分发与积分策略；用户通过积分申请二级域名（子域名），系统在 Cloudflare 上创建对应的 DNS 记录并在本地记录与管理。

技术栈示例：

- 后端：Java + Spring Boot + Spring Data JPA 或 MyBatis，Maven
- DB：MySQL（Flyway/Liquibase 管理迁移）
- 前端：Vue 3 + Pinia + Vue Router + Element Plus
- 队列：RabbitMQ / Redis Streams（可选异步方案）
- 部署：Docker / Kubernetes

------

# 2. 核心功能与业务流程（高层）

- 管理员：添加 CF 账号（Global API Key / API Token）、同步 Zones、选择启用分发域名、同步 DNS 记录、设置积分策略、审计与用户管理。
- 用户：注册/登录（支持邀请码）、首登赠点、用积分申请子域（填写前缀、记录值、备注等）、查看/释放域名、生成/使用邀请码、充值积分。
- 流程要点：用户申请子域 -> 检查积分 -> 扣分 -> 创建本地记录 -> 调用 Cloudflare API 创建 DNS -> 最终确认/回滚。

------

# 3. 数据库设计（MySQL） — 关键表 DDL（示例）

> 可用 Flyway 管理下列 SQL

```
-- users
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(100),
  invite_code VARCHAR(32) UNIQUE,
  inviter_id BIGINT NULL,
  points INT DEFAULT 0,
  role ENUM('USER','ADMIN') DEFAULT 'USER',
  status TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- system_settings
CREATE TABLE system_settings (
  k VARCHAR(100) PRIMARY KEY,
  v TEXT,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- cf_accounts
CREATE TABLE cf_accounts (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(100),
  api_key VARCHAR(255),
  api_type ENUM('GLOBAL_KEY','API_TOKEN') DEFAULT 'GLOBAL_KEY',
  enabled TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- zones
CREATE TABLE zones (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  cf_account_id BIGINT,
  zone_id VARCHAR(128) NOT NULL,
  name VARCHAR(255) NOT NULL,
  status VARCHAR(50),
  enabled TINYINT DEFAULT 0,
  synced_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (cf_account_id, zone_id),
  INDEX (name)
);

-- dns_records
CREATE TABLE dns_records (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  zone_id BIGINT,
  cf_record_id VARCHAR(128),
  name VARCHAR(255),
  type VARCHAR(10),
  content VARCHAR(255),
  ttl INT,
  proxied TINYINT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE (zone_id, cf_record_id)
);

-- user_domains
CREATE TABLE user_domains (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT,
  zone_id BIGINT,
  dns_record_id BIGINT,
  subdomain_prefix VARCHAR(128),
  full_domain VARCHAR(255),
  status ENUM('ACTIVE','PENDING','REVOKED') DEFAULT 'ACTIVE',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE (user_id, full_domain)
);

-- points_transactions
CREATE TABLE points_transactions (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT,
  change_amount INT,
  balance_after INT,
  type VARCHAR(50),
  remark VARCHAR(255),
  related_id BIGINT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- audit_logs
CREATE TABLE audit_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  actor_id BIGINT,
  action VARCHAR(100),
  target VARCHAR(100),
  detail TEXT,
  ip VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

（可扩展表：`payment_orders`、`invite_codes`、`sync_jobs`、`task_queue`、`rate_limit`）

------

# 4. 系统设置（管理员可配置）

- `initial_register_points`（默认 1）
- `invitee_points`（默认 3）
- `inviter_points`（默认 3）
- `domain_cost_points`（默认 5）
- `sync_cron_expression`
- `default_ttl`
- `max_domains_per_user`
- `allow_user_set_invite`（布尔）
   这些存于 `system_settings`，管理员 UI 提供修改入口。

------

# 5. 后端 API（REST）概览（示例）

返回标准 JSON：`{ code, message, data }`。鉴权用 JWT。

**公共 / 认证**

- `POST /api/auth/register` `{username,email,password,inviteCode?}`
- `POST /api/auth/login` `{username,email,password}`
- `POST /api/auth/logout`

**管理员（ADMIN）**

- `POST /api/admin/cf-accounts` 添加 CF 账号
- `GET /api/admin/cf-accounts`
- `POST /api/admin/zones/sync` 手动同步 zones
- `GET /api/admin/zones`
- `POST /api/admin/zones/{zoneId}/enable` 启用/禁用
- `POST /api/admin/zones/{zoneId}/sync-records` 同步该 zone 的 DNS 记录
- `GET /api/admin/zones/{zoneId}/records`
- `GET /api/admin/settings` / `PUT /api/admin/settings`

**用户**

- `GET /api/zones` 获取已启用分发的 zone 列表
- `POST /api/user/domains/apply` 申请子域（zoneId,prefix,type,value,ttl,remark）
- `GET /api/user/domains` 用户域名列表
- `DELETE /api/user/domains/{id}` 释放子域
- `GET /api/user/points` 积分余额 + 流水
- `POST /api/user/invite/generate` / `GET /api/user/invite/mycode`
- `POST /api/user/recharge` 创建充值订单

（建议同时提供 Admin Swagger/OpenAPI 文档）

------

# 6. Cloudflare 集成要点

- 列 zone：`GET https://api.cloudflare.com/client/v4/zones`

  - Header: `Authorization: Bearer <token>` 或 `X-Auth-Email` + `X-Auth-Key`

- 列 DNS：`GET https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records`

- 创建 DNS：`POST https://api.cloudflare.com/client/v4/zones/{zone_id}/dns_records`

  ```
  { "type":"A", "name":"alice.example.com", "content":"1.2.3.4", "ttl":120, "proxied":false }
  ```

实现建议：

- 用 `WebClient` 或 `RestTemplate`（Spring WebFlux/WebClient 推荐）并设置超时、重试、限流。
- 将 CF api_key 在 DB 中加密存储（AES，加密密钥放在环境变量/Secret Manager）。
- 对外部调用做幂等性保护（请求幂等 id 或检查 DB 中是否已存在）。

简化 Java 示例（伪）：

```
HttpHeaders h = buildHeaders(cfAccount);
ResponseEntity<String> resp = restTemplate.exchange(url, HttpMethod.GET, new HttpEntity<>(h), String.class);
```

------

# 7. 申请子域：事务与并发策略

两种可选策略：

**策略 A：同步方式（立即创建）**
 优点：申请即时完成。
 缺点：在事务里调用外部 API 会长时间占用 DB 事务，影响并发。

流程（同步，事务内）：

1. SELECT user FOR UPDATE（锁定积分行）
2. 检查积分余额
3. 更新用户积分并写 `points_transactions`
4. 调用 Cloudflare 创建 DNS（在事务内或外根据需求）
5. 写 `dns_records`、`user_domains`
6. Commit（若 CF 创建失败，抛异常并回滚）

**策略 B：异步方式（推荐高并发场景）**
 优点：高可用、可重试、减少 DB 事务时间。
 缺点：申请不即时（status=PENDING），需异步任务与补偿机制。

流程（异步）：

1. 在事务里扣分并写入 `user_domains` (status=PENDING) 与 points tx
2. 提交事务
3. 推送队列任务（RabbitMQ/Redis Stream）由 Worker 执行 CF 创建
4. Worker 成功则更新 `user_domains.status=ACTIVE` 并写 `dns_records`，失败则重试，重试失败后报警并可自动/人工返还积分。

并发保护：

- 使用 DB `SELECT ... FOR UPDATE` 或 `@Version` 乐观锁控制积分并发修改。
- 对 `user_domains` 的 `full_domain` 做唯一索引，避免重复申请。

------

# 8. 定时 & 手动同步策略

- 管理端提供手动同步 zone 和 records。
- 提供定时任务（`@Scheduled`）按 `sync_cron_expression` 执行：
  - 分页拉取 CF 记录并差异化（新增/更新/删除）。
  - 使用分布式锁（Redis）保证单 zone 同步不并发。
  - 记录 sync 日志（`sync_jobs` 表）与告警。

同步实现要点：

- 每次同步保留 `synced_at` 字段时间戳。
- 对比策略：以 CF 为主 -> 本地更新；若本地存在且 CF 删除则 mark 删除或删除本地行（依需求）。
- 同步失败或异常需记录并邮件告警。

------

# 9. 积分机制（详细）

**默认规则（管理员可配置）**

- 注册奖励：`initial_register_points`（默认 1）
- 邀请奖励：`inviter_points`（默认 3）、`invitee_points`（默认 3）
- 申请子域消耗：`domain_cost_points`（默认 5）
- 充值：按充值金额兑换积分（管理员可设比例）
- 管理员调整：可手动加/减积分（并写流水）

**防刷 & 反滥用**

- 每 IP 注册数量限制（如 5 个/日）
- 邀请奖励上限（按用户）
- 验证邮箱/手机以避免机器人
- 申请频率限制（Redis 计数器，秒级/分钟级限额）
- 审计 `points_transactions`，每笔操作记录 `related_id` 与备注

**示例 points_transactions 类型**

- `REGISTER`、`INVITE`、`APPLY_DOMAIN`、`RECHARGE`、`ADMIN_ADJUST`、`REFUND`

------

# 10. 前端（UI）建议 — 管理端与用户端页面结构

**管理员端**：

- 仪表盘（Dashboard）←（详见第 11 节）
- Cloudflare 管理：CF 账号列表、Zones 列表（启用/禁用、手动同步）
- DNS 管理：zone -> records 列表、手动编辑
- 积分设置（system_settings）
- 用户管理：用户列表、积分调整、禁用用户
- 审计日志、同步任务历史、支付/充值管理

**用户端**：

- 注册 / 登录 / 找回密码
- 个人中心（积分、我的邀请码、充值、邀请统计）
- 申请子域页面（选择域名、输入前缀、记录类型/值、显示扣分）
- 我的域名（状态、释放）
- 邀请页面（生成链接、查看邀请明细）
- 帮助/文档

------

# 11. 系统仪表板（Dashboard）设计与统计实现（重点）

仪表板应同时满足管理员查看全局系统运行态势与关键业务 KPI 的需求。下列为推荐的统计项、实现 SQL/查询示例与前端显示建议。

## 11.1 仪表板显示模块（建议）

1. **系统概览（顶部卡片）**
   - 总用户数（Total Users）
   - 本周新增用户（Users This Week）
   - 总域名（Zones 已导入）
   - 启用用于分发的域名数（Enabled Zones）
   - DNS 记录总数（Total DNS Records）
   - 今日新增 DNS 记录（DNS Today）
   - 总积分（系统内所有用户积分总和）
   - 活跃用户数（Active Users，定义：近 7 天有登录或操作）
2. **邀请 / 卡密 / 积分系统卡片**
   - 总邀请码数 / 已使用邀请码 / 有效邀请码
   - 总卡密（如有）及已使用数
   - 积分消耗总计（最近周期）
3. **记录同步 & 任务状态**
   - 当前正在同步的 zone 数（pending jobs）
   - 最近同步成功/失败统计（24h）
4. **最近 7 天用户注册趋势（折线或条形图）**
5. **最近 7 天 DNS 记录变更趋势（新增/删除）**
6. **Top Zones（按 record 数/用户申请数）**
7. **系统健康 & 报警（服务可用性、CF API 错误率、队列长度）**
8. **最近操作日志 / 最近申请记录（可分页）**

## 11.2 数据来源与 SQL 示例（MySQL）

> 以下 SQL 为示例，字段名与实际表名按你实现的 schema 调整。

**总用户数**

```
SELECT COUNT(*) AS total_users FROM users WHERE status = 1;
```

**本周新增用户**

```
SELECT COUNT(*) AS new_users_week
FROM users
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL WEEKDAY(CURDATE()) DAY)
  AND created_at < DATE_ADD(DATE_SUB(CURDATE(), INTERVAL WEEKDAY(CURDATE()) DAY), INTERVAL 7 DAY);
-- 更简单：过去7天
SELECT COUNT(*) FROM users WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY);
```

**启用分发的域名数**

```
SELECT COUNT(*) FROM zones WHERE enabled = 1;
```

**DNS 记录总数**

```
SELECT COUNT(*) FROM dns_records;
```

**今日新增 DNS 记录**

```
SELECT COUNT(*) FROM dns_records WHERE DATE(created_at) = CURDATE();
```

**系统总积分**

```
SELECT COALESCE(SUM(points),0) AS total_points FROM users;
```

**活跃用户数（近7天登录或有 domain 操作）**

```
-- 假设有 user_logins 表或 audit_logs
SELECT COUNT(DISTINCT user_id) FROM (
  SELECT user_id, MAX(created_at) AS t FROM audit_logs GROUP BY user_id
) AS a WHERE t >= DATE_SUB(NOW(), INTERVAL 7 DAY);
```

**最近7天用户注册趋势（按天）**

```
SELECT DATE(created_at) AS day, COUNT(*) AS cnt
FROM users
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
GROUP BY DATE(created_at)
ORDER BY day;
```

**最近7天 DNS 记录新增/删除（可用 dns_records.created_at 与 audit_logs）**

```
SELECT DATE(created_at) AS day, COUNT(*) AS added
FROM dns_records
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
GROUP BY DATE(created_at)
ORDER BY day;
```

**Top Zones（按 DNS 记录数）**

```
SELECT z.name, COUNT(r.id) AS record_count
FROM zones z
LEFT JOIN dns_records r ON r.zone_id = z.id
WHERE z.enabled = 1
GROUP BY z.id
ORDER BY record_count DESC
LIMIT 10;
```

**同步任务状态（示例表 sync_jobs）**

```
SELECT status, COUNT(*) FROM sync_jobs GROUP BY status;
```

**队列长度（例如 Redis 队列）**

- 在后端通过 Redis `LLEN` 或 MQ 管理接口查询并返回。

## 11.3 仪表盘指标实现建议（性能与实时性）

- **缓存策略**：部分实时性要求不高的指标（如总用户数、总积分、Top Zones）可以每 30s~5min 缓存到 Redis；趋势图可缓存更久或按需计算。
- **实时指标**：CF API 错误率、正在同步任务、队列长度等需要即时查询 MQ/Redis/监控系统。
- **计算层**：推荐建立一个 `metrics` 服务（Spring Boot）负责聚合指标（定时任务 + 缓存），前端请求 `GET /api/admin/dashboard` 一次性拉取所有卡片数据，以减少前端多次请求。
- **分页与筛选**：日志与记录列表使用分页 API（`/api/admin/audit?page=...`）。
- **安全**：Dashboard 仅对 ADMIN 角色开放，接口加权限校验与速率限制。

## 11.4 Dashboard API 示例

- `GET /api/admin/dashboard/summary` — 返回顶部卡片（总用户、今日新增、总域名等）
- `GET /api/admin/dashboard/trends?days=7` — 返回注册与 DNS 变更趋势数据
- `GET /api/admin/dashboard/top-zones` — Top zones
- `GET /api/admin/dashboard/sync-status` — 同步任务与队列长度
- `GET /api/admin/dashboard/recent-activity?page=1&size=20` — 最近操作日志

**返回示例**

```
{
  "summary": {
    "totalUsers": 1024,
    "newUsers7d": 34,
    "zonesTotal": 45,
    "zonesEnabled": 30,
    "dnsRecordsTotal": 2345,
    "dnsToday": 12,
    "totalPoints": 5120,
    "activeUsers7d": 120
  },
  "trends": {
    "users": [{"day":"2025-09-01","count":5}, ...],
    "dns": [{"day":"2025-09-01","added":10}, ...]
  },
  "topZones": [{"name":"example.com","recordCount":400},...],
  "syncStatus": {"runningJobs":2,"failedLast24h":1,"queueLength":3},
  "recentActivity": [{ "user":"admin","action":"sync_zone","detail":"zone x","createdAt":"..." }, ...]
}
```


# Development
npm run dev              # Development server
npm run build:dev        # Development build

# Production
npm run build            # Production build
npm run dev:prod         # Production preview
npm run preview:prod     # Production preview server